name: CI Dev Tests
on:
  push:
    branches: [ 'master' ]
  pull_request:
    branches: [ 'master' ]

permissions:
  contents: read

jobs:
  drift-ci-dev-tests:
    name: Drift CI Developers' tests
    defaults:
      run:
        working-directory: ./drift-backend
    if: github.actor != 'dependabot[bot]' # don't run on dependabot's actions directly
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install poetry
        run: pipx install poetry~=1.6.0
      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'poetry'
      - name: Install dependencies
        run: poetry install --with dev --verbose
      - name: Check manifest
        run: poetry run ./scripts/check-manifest.sh
      - name: Lint with flake8
        run: poetry run flake8
      - name: Lint with black
        run: poetry run black . --check -t py39
      - name: Lint OpenAPI mgmt_api Spec
        run: poetry run yamllint drift/openapi/mgmt_api.spec.yaml
      - name: Lint OpenAPI mgmt_api Spec
        run: poetry run yamllint drift/openapi/api.spec.yaml
      - name: Run unit tests
        run: poetry run ./run_unit_tests.sh
      - name: Upload Code Coverage
        uses: codecov/codecov-action@v3
        with:
          verbose: true
  baselines-ci-dev-tests:
    name: System Baselines CI Developers' tests
    defaults:
      run:
        working-directory: ./system-baseline-backend
    if: github.actor != 'dependabot[bot]' # don't run on dependabot's actions directly
    services:
      postgres:
        image: postgres
        env:
          POSTGRES_PASSWORD: insights
          POSTGRES_USER: insights
          POSTGRES_DB: baselinedb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install poetry
        run: pipx install poetry~=1.6.0
      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'poetry'
      - name: Install dependencies
        run: poetry install --with dev --verbose
      - name: Check manifest
        run: poetry run ./scripts/check-manifest.sh
      - name: Lint with flake8
        run: poetry run flake8
      - name: Lint with black
        run: poetry run black . --check -t py39
      - name: Lint OpenAPI mgmt_api Spec
        run: poetry run yamllint system_baseline/openapi/mgmt_api.spec.yaml
      - name: Lint OpenAPI api Spec
        run: poetry run yamllint system_baseline/openapi/api.spec.yaml
      - name: Lint OpenAPI internal_api Spec
        run: poetry run yamllint system_baseline/openapi/internal_api.spec.yaml
      - name: Validate OpenAPI mgmt_api Spec
        run: poetry run openapi-spec-validator system_baseline/openapi/mgmt_api.spec.yaml
      - name: Validate OpenAPI api Spec
        run: poetry run openapi-spec-validator system_baseline/openapi/api.spec.yaml
      - name: Validate OpenAPI internal_api Spec
        run: poetry run openapi-spec-validator system_baseline/openapi/internal_api.spec.yaml
      - name: Run unit tests
        run: poetry run ./run_unit_tests.sh
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Downloads openapi-generator-cli
        run: wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/4.1.1/openapi-generator-cli-4.1.1.jar
      - name: Validate OpenAPI api spec using openapi-generator-cli
        run:  java -jar openapi-generator-cli-4.1.1.jar validate -i system_baseline/openapi/api.spec.yaml
      - name: Upload Code Coverage
        uses: codecov/codecov-action@v3
        with:
          verbose: true
  hsps-ci-dev-tests:
    name: Historical System Profiles CI Developers' tests
    defaults:
      run:
        working-directory: ./historical-system-profiles-backend
    if: github.actor != 'dependabot[bot]' # don't run on dependabot's actions directly
    services:
      postgres:
        image: postgres
        env:
          POSTGRES_PASSWORD: insights
          POSTGRES_USER: insights
          POSTGRES_DB: insights
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install poetry
        run: pipx install poetry~=1.6.0
      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'poetry'
      - name: Install dependencies
        run: poetry install --with dev --verbose
      - name: Check manifest
        run: poetry run ./scripts/check-manifest.sh
      - name: Lint with flake8
        run: poetry run flake8
      - name: Lint with black
        run: poetry run black . --check -t py39
      - name: Lint OpenAPI mgmt_api Spec
        run: poetry run yamllint historical_system_profiles/openapi/mgmt_api.spec.yaml
      - name: Lint OpenAPI api Spec
        run: poetry run yamllint historical_system_profiles/openapi/api.spec.yaml
      - name: Validate OpenAPI mgmt_api Spec
        run: poetry run openapi-spec-validator historical_system_profiles/openapi/mgmt_api.spec.yaml
      - name: Validate OpenAPI api Spec
        run: poetry run openapi-spec-validator historical_system_profiles/openapi/api.spec.yaml
      - name: Run unit tests
        run: poetry run ./run_unit_tests.sh
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Downloads openapi-generator-cli
        run: wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/4.1.1/openapi-generator-cli-4.1.1.jar
      - name: Validate OpenAPI api spec using openapi-generator-cli
        run:  java -jar openapi-generator-cli-4.1.1.jar validate -i historical_system_profiles/openapi/api.spec.yaml
      - name: Upload Code Coverage
        uses: codecov/codecov-action@v3
        with:
          verbose: true
  kerlescan-ci-dev-tests:
    name: Kerlescan CI Developers' tests
    defaults:
      run:
        working-directory: ./kerlescan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Install poetry
        run: pipx install poetry~=1.6.0
      - name: Set up Python 3.9
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'
          cache: 'poetry'
      - name: Install dependencies
        run: poetry install --with dev --verbose
      - name: Lint with flake8
        run: poetry run flake8
      - name: Lint with black
        run: poetry run black . --check -t py39
      - name: Run unit tests --cov-report xml
        run: poetry run pytest
      - name: Upload Code Coverage
        uses: codecov/codecov-action@v3
        with:
          verbose: true
